---
title: "Fungal OTU's across life stages of boreal toad: published and supplemental analyses"
author: "Alexandra Alexiev"
date: "12/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, # evaluate code chunks
                      include = TRUE, # include the console output of the code in the final document
                      echo = TRUE, # include the code that generated the report in the final report
                      warning = FALSE, # include warnings
                      message = FALSE, # include console messages
                      collapse = TRUE, # Merge code blocks and output blocks, if possible.
                      dpi = 300, # the default figure resolution
                      fig.dim = c(9, 5), # the default figure dimensions
                      out.width = '98%', # the default figure output width
                      out.height = '98%', # the default figure output height
                      cache = TRUE) # save the calculations so that kniting is faster each time. (Sometimes this option can cause issues and images won't reflect the most recent code changes, if this happens, just delete the *_cache folder and reknit the code.)
```

```{r}
#packages and set working directory
library(vegan)
library(ggplot2)
library(mctoolsr)
library(tidyr)
library(tibble)
library(gridExtra)
library(indicspecies)
library(dplyr)
library(ggpubr)
library(cowplot)
library(kableExtra)
set.seed(33333)
work_dir <- "/Users/alal3493/Documents/Projects/DevelopmentalBorealToad/FungalDevData/02_PublishedAnalysis/"
seq_dir <- "/Users/alal3493/Documents/Projects/DevelopmentalBorealToad/FungalDevData/00_SeqProcessing/"
```


## Basic measures of highly abundant or present taxa

```{r}
#load in starting files
mapfp_all <- paste0(work_dir,"Allsamps_clean_maptab.txt")
tabfp_all <- paste0(work_dir,"Allsamps_clean_otutab.txt")
input_all <- load_taxa_table(tab_fp = tabfp_all, map_fp = mapfp_all) # this file has both toad and environment sample types in it (172 samples)
mapfp_t <- paste0(work_dir,"Toad_clean_maptab.txt")
tabfp_t <- paste0(work_dir,"Toad_clean_otutab.txt")
input_toad <- load_taxa_table(tab_fp = tabfp_t, map_fp = mapfp_t) # this file only has toad samples in it (124 samples)

# order by life stage
life_list <- c("Soil", "Sediment", "Water",
               "Eggs.11.15", "Tadpole.20.22",
               "Tadpole.23.25", "Tadpole.25.27",
               "Tadpole.27.29", "Tadpole.29.31",
               "Tadpole.31.35", "Tadpole.36.39",
               "Metamorph.40.46", "Subadult", "Adult")
input_all$map_loaded$Gosner_Stage <-
    factor(input_all$map_loaded$Gosner_Stage,
           levels=life_list)
input_toad$map_loaded$Gosner_Stage <-
    factor(input_toad$map_loaded$Gosner_Stage,
           levels=life_list)
# and order the other column I'll be using as well, where tadpoles are lumped
samptype_list <- c("Soil", "Sediment", "Water", "Eggs",
                   "Tadpole", "Metamorph", "Subadult", "Adult")
input_all$map_loaded$Life_Stage_Simplified <-
    factor(input_all$map_loaded$Life_Stage_Simplified,
           levels=samptype_list)
input_toad$map_loaded$Life_Stage_Simplified <-
    factor(input_toad$map_loaded$Life_Stage_Simplified,
           levels=samptype_list)
```

```{r}
# number of total fungal taxa found in all samples
nrow(input_all$data_loaded) # 2243
nrow(input_toad$data_loaded) # 1703

# top ten taxa on toads and in environment
toptaxa_all <- return_top_taxa(input = input_all, number_taxa = 10)
toptaxa_toad <- return_top_taxa(input = input_toad, number_taxa = 10)
kable(toptaxa_all, caption="Top ten taxa in toad and environment samples") %>% 
    kable_styling(bootstrap_options = c("striped","bordered"), 
                  full_width = F, position = "left")
kable(toptaxa_toad, caption="Top ten taxa in toad samples") %>% 
    kable_styling(bootstrap_options = c("striped","bordered"), 
                  full_width = F, position = "left")
```


# Q1: What are the factors associated with variation in fungal communities?

## Alpha diversity differences between life stages and environment samples

Below is a supplementary figure comparing three alpha diversity measures across all the sample types. Since site is a confounding factor here, given exploratory analyses, I analyzed with blocking by site ("strata").

```{r}
# calculate alpha diversity measures
input_all$map_loaded$rich = calc_diversity(
  tax_table = input_all$data_loaded, metric = 'richness')
input_all$map_loaded$simpson = calc_diversity(
  tax_table = input_all$data_loaded, metric = 'simpson')
input_all$map_loaded$shannon = calc_diversity(
  tax_table = input_all$data_loaded, metric = 'shannon')

# Kruskall-Wallis test on life stages, strata-site
# species richness
krusk_rich <- kruskal.test(input_all$map_loaded$rich ~ 
                              input_all$map_loaded$Gosner_Stage)
bonpval_rich <- p.adjust(p = krusk_rich$p.value, method = "bonferroni", 
         n = length(unique(input_all$map_loaded$Gosner_Stage)))
krusk_rich; bonpval_rich

# simpson (evenness)
krusk_simp <- kruskal.test(input_all$map_loaded$simpson ~ 
                              input_all$map_loaded$Gosner_Stage)
bonpval_simp <- p.adjust(p = krusk_simp$p.value, method = "bonferroni", 
         n = length(unique(input_all$map_loaded$Gosner_Stage)))
krusk_simp; bonpval_simp

# shannon (both richness and evenness)
krusk_shan <- kruskal.test(input_all$map_loaded$shannon ~ 
                              input_all$map_loaded$Gosner_Stage)
bonpval_shan <- p.adjust(p = krusk_shan$p.value, method = "bonferroni", 
         n = length(unique(input_all$map_loaded$Gosner_Stage)))
krusk_shan; bonpval_shan

# GRAPHING
# Species richness graphs: mean number of OTUs found per sample type
liferich <- ggplot(input_all$map_loaded, aes(Gosner_Stage, rich)) + 
  geom_boxplot() + xlab("") + 
  ylab("Fungal OTU Richness") + ggtitle("A") +
  geom_text(x=7,y=194, size=3,
            label=paste0("KW chi-sq stat=",signif(krusk_rich$statistic, digits=5),
                         "\n","p=",signif(bonpval_rich, digits=3))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, colour = "black"),
        axis.text.y = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))

# Simpson's: measures species/OTU evenness, or how close in number each species in the environment
lifesimp <- ggplot(input_all$map_loaded, aes(Gosner_Stage, simpson)) + 
  geom_boxplot() + xlab("Sample Type") + 
  ylab("Simpson's Diversity Metric") +  ylim(0,1.2) + ggtitle("B") +
  geom_text(x=7,y=1.15, size=3,
            label=paste0("KW chi-sq stat=",signif(krusk_simp$statistic, digits=5),
                         "\n","p=",signif(bonpval_simp, digits=3))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, colour = "black"),
        axis.text.y = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))

# Shannon: combination of richness and evenness
lifeshan <- ggplot(input_all$map_loaded, aes(Gosner_Stage, shannon)) + 
  geom_boxplot() + xlab("") + 
  ylab("Shannon Diversity Index") + ggtitle("C") +
  geom_text(x=7,y=4.1, size=3,
            label=paste0("KW chi-sq stat=",signif(krusk_shan$statistic, digits=5),
                         "\n","p=",signif(bonpval_shan, digits=3))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, colour = "black"),
        axis.text.y = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))

alpha_panel <- grid.arrange(liferich, lifesimp, lifeshan, ncol = 3)
# ggsave(paste0(work_dir,"Figs_Tables/AllAlphaDiv.png"), alpha_panel, dpi=300,
#        width=10, height=7)
```

# Pairwise OTU richness Stats

- Here, I'm using a two-sample Mann-Whitney test (or unpaired wilcoxon test). This is a non-parametric test of whether two populations are different across two different life stages, while still assuming those populations are independent. Since my samples came from different animals at different life stages, I need to make this assumption, so I cannot use a paired wilcoxon test.
- I calculated Bonferroni (signif if p<=0.05) and FDR (p<=0.05) p-value corrections, used both together to figure out how big of a difference there was between each life stage.

```{r}
# Are pairwise alpha diversities same or different across life stages?
nlevels(input_all$map_loaded$Gosner_Stage) # 14
cats <- levels(input_all$map_loaded$Gosner_Stage) # define category levels
cats_pairs <- combn(cats, 2) # make pairs of these
pvals <- c() # output df for pvalues
Wstat <- c() # output df for Wstat
for ( i in 1:ncol(cats_pairs) ) { # for each pair of sample types
    pair <- cats_pairs[, i] # define the pair
    Gosner_rich <- input_all$map_loaded %>% # take the mapping file
    dplyr::select(Gosner_Stage, rich) %>% # select these two columns from it
    filter(Gosner_Stage %in% pair) # filter the sample types in the pair
    wil <- wilcox.test(rich ~ Gosner_Stage, data = Gosner_rich, paired = F, exact = F) # run Wilcoxon test
    pvals <- c(pvals, wil$p.value) # save the p val
    Wstat <- c(Wstat, wil$statistic) # save the W statistic
}
results <- data.frame(t(cats_pairs), Wstat, pvals) # make a dataframe of the useful outputs
results$pvalBon = pvals * length(pvals) # calc bonferroni pval correction
results$pvalFDR = round(pvals * (length(pvals) / rank(pvals, ties.method = "average")),
                          3) # calc FDR pval correction
results <- results %>%
  arrange(pvalBon, pvalFDR) %>% # arrange in ascending order by the corrected pvals
  filter(pvalBon <= 0.05) %>%
  filter(pvalFDR <= 0.05) %>% # filter by the two corrected pvals being <= 0.05
  dplyr::select(-pvals) # remove pval column
# write.table(results, paste0(work_dir, "Figs_Tables/pairedMW_alphadiv.txt"), 
#             sep="\t", quote = F, row.names = F)
```

## Make three paneled figure with alpha and beta diversity measures
```{r}
# make color palette
nlevels(input_all$map_loaded$Life_Stage_Simplified)
brewer.pal(n = 8, name = "Dark2") # display hexcodes for the pallete I'm using but want to change slightly
samptype_cols <- c("#666666", "#A6761D", 
                   "#3a6b94", "#66A61E", 
                   "#E7298A", "#7570B3", 
                   "#D95F02", "#1B9E77")

# make OTU richness figure
OTUrich <- ggplot(input_all$map_loaded, aes(Gosner_Stage, rich)) + 
  geom_boxplot(alpha=0.6, outlier.shape=NA, aes(fill=Life_Stage_Simplified)) + xlab("") + 
  ylab("Fungal OTU Richness") + ggtitle("A") +
  geom_point(aes(fill=Life_Stage_Simplified), size=3, shape=21, position=position_jitter(
    width=0.25
  )) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, colour = "black"),
        axis.text.y = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position="none") +
  labs(fill="Sample Type") +
  scale_fill_manual(values=samptype_cols) +
  scale_x_discrete(labels=c("Soil", "Sediment", "Water",
                            "Eggs", "Tadpole (20-22)",
                            "Tadpole (23-25)", "Tadpole (25-27)",
                            "Tadpole (27-29)", "Tadpole (29-31)",
                            "Tadpole (31-35)", "Tadpole (36-39)",
                            "Metamorph (40-46)", "Subadult", "Adult"))

# make NMDS plot
# create distance matrix
md_transformed <- t(sqrt(input_all$data_loaded))
dm <- vegdist(md_transformed, method = "bray")

# run NMDS
md.nmds <- metaMDS(dm, k = 3, trymax = 1000) #solution reached, stress=0.19

#prepare NMDS points and values for graphing
md.nmds.points <- md.nmds$points %>% # take the NMDS points
  data.frame() %>% # make a data frame
  rownames_to_column(var = "mysamples") %>%
  mutate(SampleID = mysamples) %>%
  column_to_rownames(var = "mysamples")
meta <- input_all$map_loaded %>%
  rownames_to_column("SampleID")
md.nmds.metadata <- inner_join(x=md.nmds.points, y=meta, by = "SampleID") %>%
  group_by(Life_Stage_Simplified) %>%
  ungroup() %>%
  dplyr::select(SampleID, MDS1, MDS2, everything()) # select these columns only
md.nmds.metadata.unq <- md.nmds.metadata %>%
  dplyr::select(Life_Stage_Simplified, Type) %>%
  unique()
md.nmds.metadata.unq$Life_Stage_Simplified <- 
  factor(md.nmds.metadata.unq$Life_Stage_Simplified, 
                          levels=samptype_list)

# get stress value
stress.md = paste("stress =", round(md.nmds$stress, digits = 4))

# get NMDS hulls
group.chulls <- plyr::ddply(md.nmds.metadata, "Life_Stage_Simplified", 
                            function(df) df[chull(df$MDS1, df$MDS2), ])

# Plot NMDS
nmds.plot <- ggplot(md.nmds.metadata, aes(x = MDS1, y = MDS2, shape = Type,
                                          colour = Life_Stage_Simplified)) +
  geom_polygon(data = group.chulls, 
               aes(fill=Life_Stage_Simplified), 
               alpha = 0.15, linetype=0) +
  geom_point(size=3) +
  annotate("text", x = Inf, y = Inf, label = stress.md, hjust = 1, vjust = 1) +
  ggtitle("C") + 
  labs(colour="Sample Type") +
  scale_colour_manual(values=samptype_cols) +
  scale_fill_manual(values=samptype_cols) +
  guides(fill=F, color = guide_legend(order = 1, override.aes=list(shape=15, size=6)), 
         shape = guide_legend(order = 0)) +
  scale_shape_discrete(name = "", labels = c("Environment", "Toad")) +
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=14),
        legend.title = element_text(size=16),
        legend.text = element_text(size=14))


# Make dispersion graph
# PERMDisp on sample type, strata=site
#create B-C species abundance matrix
input_all_rel <- convert_to_relative_abundances(input_all)
BC <- calc_dm(input_all_rel$data_loaded, method = "bray")
life.disper.lump <- betadisper(BC, input_all$map_loaded$Life_Stage_Simplified)
permutest(life.disper.lump)
PermDisp_life_lump <- TukeyHSD(life.disper.lump) #Tukey post-hoc
kable(PermDisp_life_lump$group) %>%
  kable_styling(bootstrap_options = c("striped","bordered"), 
                full_width = F, position = "left")
# write.table(PermDisp_life_lump$group,
#             paste0(work_dir,"Figs_Tables/PermDisp_life_lump.txt"), sep="\t")
Disper1 <- data.frame(life.disper.lump$distances)
colnames(Disper1) <- "dispers"
Disper2 <- Disper1 %>%
  rownames_to_column("SampleID") %>%
  inner_join(y=meta, 
             by="SampleID")

disper_bars <- ggplot(data=Disper2, aes(x=Life_Stage_Simplified, y=dispers)) +
  geom_boxplot(aes(fill=Life_Stage_Simplified), alpha=0.6,outlier.shape=NA) + 
  ylab("Dispersion") + xlab("") + ggtitle("B") +
  geom_point(aes(fill=Life_Stage_Simplified), size=3, shape=21, position=position_jitter(
    width=0.25
  )) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, colour = "black"),
        axis.text.y = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black")) +
  labs(fill="Sample Type") +
  scale_fill_manual(values=samptype_cols)
legend <- arrangeGrob(get_legend(disper_bars))
disper_bars_noleg <- disper_bars + theme(legend.position = "none")


# Put all into paneled graph with annotations and shared legend
diversity_fig <- ggpubr::ggarrange(arrangeGrob(OTUrich, disper_bars_noleg), 
                              legend, nmds.plot, ncol=3, 
               widths=c(4,1,9))
# ggsave(paste0(work_dir,"Figs_Tables/FungDivFig.png"), diversity_fig, dpi=400,
#        width=14, height=7)
```

## Permanova for the above plot

```{r}
# PERMANOVA on life stage, strata=site
Perm <- adonis(BC ~ input_all$map_loaded$Life_Stage_Simplified, 
                        strata = input_all$map_loaded$Location)
kable(Perm$aov.tab) %>%
  kable_styling(bootstrap_options = c("striped","bordered"), 
                full_width = F, position = "left")

#also show the pairwise PERMANOVA
pw_perm <- read.delim(paste0(work_dir,"Figs_Tables/PW_PERM.txt"))
kable(pw_perm) %>%
  kable_styling(bootstrap_options = c("striped","bordered"), 
                full_width = F, position = "left")
```


# Q2: Are there transient versus symbiotic OTU's on boreal toad skin?

Which fungi are more likely to be symbionts in that they are associated with the host as opposed to transiently moving through the host system?



